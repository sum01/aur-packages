# Maintainer: Sum1 https://github.com/sum01
pkgname=('vcash')
pkgver=0.6.0.3
pkgrel=1
pkgdesc="A decentralized currency for the internet."
arch=('i686' 'x86_64')
url="https://github.com/openvcash/vcash"
license=('AGPL3')
depends=('screen' 'gcc') # gcc=5.3.0 doesn't work (old/broken links inside of the official source list)
makedepends=('curl' 'make') # 'sed'
backup=('~/vcash/backup/' '~/.vcash/backup/') # these need fixing
source=(#'https://git.archlinux.org/svntogit/packages.git/snapshot/packages-f201309ce0fbd907e002ca839d661be58f2147ed.tar.xz'
        "https://github.com/openvcash/vcash/archive/${pkgver}.tar.gz"
        'https://www.openssl.org/source/openssl-1.0.2k.tar.gz'
        'https://github.com/sum01/aur-packages/raw/master/vcash/db-6.1.29.NC.tar.gz' # Using my own git instead of oracle's link since theirs has out-of-date certs
        'https://sourceforge.net/projects/boost/files/boost/1.53.0/boost_1_53_0.tar.gz')
sha256sums=(#'bebdfc94877fc368b5e53ea18647c36e9a7f19ef65641c9f335333b082fc8a45'
            '7b67e98bb250b8e6c03462f31f403a8ffb5a84366c86bf7f05bd0bd3ab03617b'
            '6b3977c61f2aedf0f96367dcfb5c6e578cf37e7b8d913b4ecb6643c3cb88d8c0'
            'e3404de2e111e95751107d30454f569be9ec97325d5ea302c95a058f345dfe0e'
            '7c4d1515e0310e7f810cbbc19adb9b2d425f443cc7a00b4599742ee1bdfd4c39')

build() {
  # Getting & installing old GCC v5.3.0-5
  # TEMP COMMENTED OUT
  #cd $srcdir/packages-f201309ce0fbd907e002ca839d661be58f2147ed/repos/core-x86_64
  #sed -i -e 's/_snapshot=5-20160209/_snapshot=5-20160705/g' PKGBUILD
  #sed -i -e 's/499161c65b639aa5c12a14944582b7ec/4bf0b674e27d6c9b8dc7f5a9fd3c5df2/g' PKGBUILD # Gets it to run, but it goes on "forever" with errors
  #makepkg -csi PKGBUILD

  mkdir -p $pkgdir/{usr/{lib/$pkgname,share/applications},~/$pkgname/{backup,src/{deps/{openssl,db,boost},coin/test}}}/
  cp -r $srcdir/$pkgname $pkgdir/~/$pkgname

  # Build openssl
  cp -r $srcdir/openssl-1.0.2k $pkgdir/~/$pkgname/src/deps/openssl
  cd $pkgdir/~/$pkgname/src/deps/openssl/openssl-1.0.2k
  ./config threads no-comp --prefix=$pkgdir/~/$pkgname/src/deps/openssl/
  make -j$job depend && make -j$job && make install && touch $pkgdir/~/$pkgname/src/deps/openssl/current_openssl_1.0.2k

  # Build berkeley-db
  cp -r $srcdir/db-6.1.29.NC $pkgdir/~/$pkgname/src/deps/db
  cd $pkgdir/~/$pkgname/src/deps/db/db-6.1.29.NC/build_unix/
  ../dist/configure --enable-cxx --disable-shared --prefix=$pkgdir/~/$pkgname/src/deps/db/
  make -j$job && make install && touch $pkgdir/~/$pkgname/src/deps/db/current_db_6.1.29.NC

  # Build boost
  cp -r $srcdir/boost_1_53_0 $pkgdir/~/$pkgname/src/deps/boost
  cd $pkgdir/~/$pkgname/src/deps/boost/boost_1_53_0
  ./bootstrap.sh
  ./bjam -j$job link=static toolset=gcc cxxflags=-std=gnu++0x --with-system release &
	touch $VCASH_ROOT/src/deps/boost/current_boost_1_53_0

  # Build Vcash daemon
  cd $pkgdir/~/$pkgname/src/coin/test/
  $pkgdir/~/$pkgname/src/deps/boost/bjam -j$job toolset=gcc cxxflags=-std=gnu++0x release
  cd $pkgdir/~/$pkgname/src/coin/test/bin/gcc-*/release/link-static/
  strip $pkgdir/~/$pkgname/src/coin/test/bin/gcc-*/release/link-static/stack # Again, no idea if this'll work
  cp $pkgdir/~/$pkgname/src/coin/test/bin/gcc-*/release/link-static/stack $pkgdir/~/$pkgname/vcashd
}

package() {
  # Making a script to run vcash and a desktop shortcut to it
  cd $srcdir/
  touch $pkgname.sh
  echo '#!/bin/bash' > $pkgname.sh
  echo "cd ~/vcash/" >> $pkgname.sh
  echo "ps x | grep '[v]cashd'" >> $pkgname.sh
  echo "screen -d -S vcashd -m ./vcashd" >> $pkgname.sh
  touch $pkgname.desktop
  echo '[Desktop Entry]' > $pkgname.desktop
  echo 'Name=Vcash' >> $pkgname.desktop
  echo "Comment=Launches the Vcash daemon - v${pkgver}" >> $pkgname.desktop
  echo "Exec=sh /usr/lib/$pkgname/$pkgname.sh" >> $pkgname.desktop
  echo 'Icon=vcash' >> $pkgname.desktop
  echo 'Terminal=true' >> $pkgname.desktop
  echo 'Type=Application' >> $pkgname.desktop
  echo 'Categories=Utilities;Finance;Cryptocurrency;' >> $pkgname.desktop

  # Put run script and shortcut in folders
  cp $srcdir/$pkgname.sh $pkgdir/usr/lib/$pkgname
  cp $srcdir/$pkgname.desktop ${pkgdir}/usr/share/applications
}
